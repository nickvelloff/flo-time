
class DirectRuntime extends Base
  constructor: () ->
    super()
    @clients = []

  _connect: (client) ->
    @clients.push client

  _disconnect: (client) ->
    return if (@clients.indexOf(client) == -1)
    @clients.splice @clients.indexOf(client), 1

  _receive: (msg) ->
    # Forward to Base
    @receive msg

  send: (protocol, topic, payload, context) ->
    return if not context.client
    m =
      protocol: protocol
      command: topic
      payload: payload
    context.client._receive m

  sendAll: (protocol, topic, payload) ->
    m =
      protocol: protocol
      command: topic
      payload: payload
    for client in @clients
      client._receive m
    

class DirectClient extends EventEmitter
  constructor: (runtime) ->
    super()
    @runtime = runtime

  connect: () ->
    @runtime._connect client

  disconnect: () ->
    @runtime._disconnect client

  send: (protocol, topic, payload) ->
    m =
      protocol: protocol
      command: topic
      payload: payload
    @runtime._receive m

  _receive: (message) ->
    @emit 'message', message
